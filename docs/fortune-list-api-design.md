# MingPan MCP 运势列表功能规划

> 版本: 1.1.0
> 创建日期: 2024-12-16
> 更新日期: 2025-12-16
> 状态: 规划中

## 1. 设计原则

### 1.1 MCP 职责边界

**MCP = 计算器，Agent = 分析师**

MCP 只提供 Agent 无法自行计算的信息：
- ✅ 必须提供：干支（需节气天文计算）、节气精确时间、大运起运年龄、星曜宫位、四化落宫
- ❌ 不提供：十神（查表即得）、藏干（固定知识）、五行生克（基本规则）

### 1.2 输出格式原则

- **文本优先**：便于 Agent 理解，节省 token（比 JSON 省约 70%）
- **人机可读**：除 Agent 外也方便人类阅读
- **与 baziwei 一致**：遵循 baziwei 的「导出文本」格式标准

### 1.3 术语严谨性

本文档及所有 MCP 输出必须严格区分：

| 分类 | 类型 | 说明 | 示例 |
|-----|-----|------|------|
| **年份** | 公历年 | Gregorian year | 2025年 |
| | 干支年 | 立春至次年立春前 | 乙巳年 |
| **月份** | 公历月 | Gregorian month (1-12) | 3月 |
| | 农历月 | Lunar month | 二月 |
| | 干支月 | 节气月（寅月~丑月） | 卯月、甲卯月 |
| **年龄** | 周岁 | 实际年龄 | 34岁 |
| | 虚岁 | 出生即1岁 | 35岁 |

## 2. 八字与紫微的月份系统差异（重要）

**这是命理学的基础知识，必须严格区分：**

### 2.1 八字流月 = 干支月（节气月）

八字以节气为月份边界，从寅月（立春）到丑月（小寒）共12个月：

| 序号 | 地支 | 起始节气 | 大约公历日期 |
|-----|-----|---------|------------|
| 1 | 寅月 | 立春 | 2月4日左右 |
| 2 | 卯月 | 惊蛰 | 3月6日左右 |
| 3 | 辰月 | 清明 | 4月5日左右 |
| 4 | 巳月 | 立夏 | 5月6日左右 |
| 5 | 午月 | 芒种 | 6月6日左右 |
| 6 | 未月 | 小暑 | 7月7日左右 |
| 7 | 申月 | 立秋 | 8月8日左右 |
| 8 | 酉月 | 白露 | 9月8日左右 |
| 9 | 戌月 | 寒露 | 10月8日左右 |
| 10 | 亥月 | 立冬 | 11月7日左右 |
| 11 | 子月 | 大雪 | 12月7日左右 |
| 12 | 丑月 | 小寒 | 次年1月6日左右 |

**重要**：丑月跨越公历年份边界，虽然公历日期在次年1月，但仍属于当前干支年。

### 2.2 紫微流月 = 农历月

紫微斗数以农历月为月份边界，从正月到腊月共12个月（含闰月处理）：

| 序号 | 农历月 | 边界 | 说明 |
|-----|-------|-----|------|
| 1 | 正月 | 初一~三十 | 春节后开始 |
| 2 | 二月 | 初一~三十 | |
| 3 | 三月 | 初一~三十 | |
| ... | ... | ... | |
| 12 | 腊月 | 初一~除夕 | 农历年最后一个月 |

**闰月处理**：农历闰月归入前一月计算（如闰四月按四月论）。

### 2.3 两套系统的差异示例

以公历 2025年2月10日 为例：
- **八字流月**：寅月（立春后）
- **紫微流月**：正月十二（农历正月）

两者可能指向同一天，但月份定义不同。

### 2.4 排序原则

- **八字**：按干支月排序（寅月→丑月），❌ 不按公历月（1月→12月）
- **紫微**：按农历月排序（正月→腊月），❌ 不按公历月（1月→12月）

## 3. 功能列表设计

### 3.1 现有功能（来自 baziwei）

baziwei 的「导出文本」已实现单一时间点的输出：
- 八字命盘 + 指定大运/流年/流月/流日
- 紫微命盘 + 指定大限/流年/流月/流日宫位

### 3.2 新增列表功能

mingpan MCP 需新增以下列表查询功能：

| 功能 | 输入 | 输出 |
|-----|-----|------|
| 大运列表 | 出生信息、查询范围 | 所有大运周期列表 |
| 流年列表 | 出生信息、干支年范围 | 指定范围内所有流年 |
| 流月列表 | 出生信息、指定干支年 | 该干支年内12个干支月 |
| 流日列表 | 出生信息、指定干支月 | 该干支月内所有流日 |

## 4. 八字列表输出格式

### 4.1 大运列表

```
【八字大运列表】

命主：[姓名]
出生：[公历年-月-日 时:分]
性别：[男/女]
日主：[天干]

大运方向：[顺行/逆行]
起运年龄：[X]周岁（[公历年]年）

序号 | 大运干支 | 起止虚岁 | 起止公历年
-----|---------|---------|----------
  1  | 甲寅    | 4-13岁  | 1990-1999年
  2  | 乙卯    | 14-23岁 | 2000-2009年
  3  | 丙辰    | 24-33岁 | 2010-2019年
  ...
```

### 4.2 流年列表

```
【八字流年列表】

命主：[姓名]
查询范围：[起始公历年]-[结束公历年]
当前大运：[干支]（[起止虚岁]）

公历年 | 干支年 | 虚岁 | 所属大运
-------|-------|------|--------
2020年 | 庚子年 | 35岁 | 丙辰运
2021年 | 辛丑年 | 36岁 | 丙辰运
2022年 | 壬寅年 | 37岁 | 丁巳运（新运）
...
```

### 4.3 流月列表

```
【八字流月列表】

命主：[姓名]
干支年：乙巳年（公历2025年）
年柱：乙巳

序号 | 干支月 | 节气起止 | 公历日期范围
-----|-------|---------|-------------
  1  | 丙寅月 | 立春-惊蛰 | 2025-02-03 ~ 2025-03-05
  2  | 丁卯月 | 惊蛰-清明 | 2025-03-05 ~ 2025-04-04
  3  | 戊辰月 | 清明-立夏 | 2025-04-04 ~ 2025-05-05
  4  | 己巳月 | 立夏-芒种 | 2025-05-05 ~ 2025-06-05
  5  | 庚午月 | 芒种-小暑 | 2025-06-05 ~ 2025-07-06
  6  | 辛未月 | 小暑-立秋 | 2025-07-06 ~ 2025-08-07
  7  | 壬申月 | 立秋-白露 | 2025-08-07 ~ 2025-09-07
  8  | 癸酉月 | 白露-寒露 | 2025-09-07 ~ 2025-10-08
  9  | 甲戌月 | 寒露-立冬 | 2025-10-08 ~ 2025-11-07
 10  | 乙亥月 | 立冬-大雪 | 2025-11-07 ~ 2025-12-06
 11  | 丙子月 | 大雪-小寒 | 2025-12-06 ~ 2026-01-05
 12  | 丁丑月 | 小寒-立春 | 2026-01-05 ~ 2026-02-03

注：丁丑月虽然公历日期在2026年，但仍属于乙巳干支年。
```

### 4.4 流日列表

```
【八字流日列表】

命主：[姓名]
干支月：丙寅月（乙巳年，公历2025-02-03 ~ 2025-03-05）

公历日期 | 干支日 | 节气
---------|-------|------
2025-02-03 | 甲子日 | 立春 05:12
2025-02-04 | 乙丑日 |
2025-02-05 | 丙寅日 |
...
2025-03-04 | 癸卯日 |

共[N]日
```

## 5. 紫微列表输出格式

### 5.1 大限列表

```
【紫微大限列表】

命主：[姓名]
出生：[公历年-月-日 时:分]
性别：[男/女]
命宫：[宫位名]（[主星]）
身宫：[宫位名]（[主星]）

大限方向：[顺行/逆行]

序号 | 虚岁范围 | 公历年范围 | 大限宫位 | 宫内主星
-----|---------|-----------|---------|--------
  1  | 4-13岁  | 1990-1999 | 命宫    | 紫微、天府
  2  | 14-23岁 | 2000-2009 | 父母宫  | 太阳
  3  | 24-33岁 | 2010-2019 | 福德宫  | 武曲、贪狼
  ...

注：四化以当前流年为准另行显示。
```

### 5.2 流年列表

```
【紫微流年列表】

命主：[姓名]
查询范围：[起始公历年]-[结束公历年]
当前大限：[宫位]（[虚岁范围]）

公历年 | 干支年 | 虚岁 | 流年宫位 | 所属大限
-------|-------|------|---------|--------
2020年 | 庚子年 | 35岁 | 子女宫  | 福德宫限
2021年 | 辛丑年 | 36岁 | 夫妻宫  | 福德宫限
2022年 | 壬寅年 | 37岁 | 兄弟宫  | 田宅宫限（新限）
...
```

### 5.3 流月列表（农历月）

```
【紫微流月列表】

命主：[姓名]
农历年：乙巳年（公历2025年）
流年宫位：[宫位名]

序号 | 农历月 | 公历日期范围 | 流月宫位 | 备注
-----|-------|-------------|---------|------
  1  | 正月  | 2025-01-29 ~ 2025-02-27 | 命宫    |
  2  | 二月  | 2025-02-28 ~ 2025-03-28 | 父母宫  |
  3  | 三月  | 2025-03-29 ~ 2025-04-26 | 福德宫  |
  4  | 四月  | 2025-04-27 ~ 2025-05-25 | 田宅宫  |
  5  | 五月  | 2025-05-26 ~ 2025-06-24 | 官禄宫  |
  6  | 六月  | 2025-06-25 ~ 2025-07-23 | 仆役宫  | 闰六月接续
  7  | 七月  | 2025-07-24 ~ 2025-08-22 | 迁移宫  |
  8  | 八月  | 2025-08-23 ~ 2025-09-20 | 疾厄宫  |
  9  | 九月  | 2025-09-21 ~ 2025-10-20 | 财帛宫  |
 10  | 十月  | 2025-10-21 ~ 2025-11-19 | 子女宫  |
 11  | 冬月  | 2025-11-20 ~ 2025-12-19 | 夫妻宫  |
 12  | 腊月  | 2025-12-20 ~ 2026-01-17 | 兄弟宫  |

注：
1. 紫微流月以农历月为准，非节气月。
2. 闰月归入前一月计算，上表示例中闰六月按六月论。
3. 公历日期仅供参考，精确边界以农历初一为准。
```

### 5.4 流日列表（农历日）

```
【紫微流日列表】

命主：[姓名]
农历月：乙巳年正月（公历2025-01-29 ~ 2025-02-27）
流月宫位：[宫位名]

农历日期 | 公历日期 | 干支日 | 流日宫位
--------|---------|-------|--------
正月初一 | 2025-01-29 | 甲子日 | 命宫
正月初二 | 2025-01-30 | 乙丑日 | 父母宫
正月初三 | 2025-01-31 | 丙寅日 | 福德宫
...
正月三十 | 2025-02-27 | 癸巳日 | 兄弟宫

共[N]日

注：紫微流日以农历日为准，流日宫位按日支定位。
```

## 6. API 设计

### 6.1 MCP Tool 定义

```typescript
// 八字大运列表
tool: "bazi_dayun_list"
input: {
  birthYear: number,      // 公历出生年
  birthMonth: number,     // 公历出生月
  birthDay: number,       // 公历出生日
  birthHour: number,      // 出生时（0-23）
  birthMinute?: number,   // 出生分
  gender: "male" | "female",
  longitude?: number,     // 经度（真太阳时修正）
  name?: string,          // 命主姓名
  count?: number          // 显示大运数量，默认10
}

// 八字流年列表
tool: "bazi_liunian_list"
input: {
  ...基本出生信息,
  startYear: number,      // 起始公历年
  endYear: number         // 结束公历年
}

// 八字流月列表
tool: "bazi_liuyue_list"
input: {
  ...基本出生信息,
  ganzYear: string        // 干支年，如 "乙巳" 或公历年如 2025
}

// 八字流日列表
tool: "bazi_liuri_list"
input: {
  ...基本出生信息,
  ganzMonth: string       // 干支月，如 "丙寅" 或需同时指定所属干支年
}
```

### 6.2 紫微 API 设计

```typescript
// 紫微大限列表
tool: "ziwei_daxian_list"
input: {
  ...基本出生信息,
  count?: number          // 显示大限数量，默认10
}

// 紫微流年列表
tool: "ziwei_liunian_list"
input: {
  ...基本出生信息,
  startYear: number,      // 起始公历年
  endYear: number         // 结束公历年
}

// 紫微流月列表（农历月）
tool: "ziwei_liuyue_list"
input: {
  ...基本出生信息,
  lunarYear: number       // 农历年（公历年），如 2025
  // 注意：紫微流月使用农历月，非干支月/节气月
}

// 紫微流日列表（农历日）
tool: "ziwei_liuri_list"
input: {
  ...基本出生信息,
  lunarYear: number,      // 农历年（公历年）
  lunarMonth: number      // 农历月（1-12，闰月用13表示或特殊标记）
  // 注意：紫微流日基于农历月份，非干支月
}
```

## 7. 实现注意事项

### 7.1 与 baziwei 的关系

- mingpan 作为 baziwei 的姐妹项目，核心计算逻辑应与 baziwei 保持同步
- 已复制的文件：`solarTerms.ts`, `BaziService.ts`, `LiuYueCalculator.ts`, `LiuRiCalculator.ts`
- 输出格式应与 baziwei 的 `fortuneTextRenderer.ts` 保持一致
- **重要参考**：baziwei 的 `LiuYueGrouper.ts` 已实现双月系统（八字干支月 + 紫微农历月）

### 7.2 月份边界精确性

**八字流月（节气边界）**：
- 使用 `lunar-javascript` 库获取精确节气时间
- 流月边界以节气精确时间为准（精确到时分）
- 公历日期范围仅供参考，精确边界以节气为准

**紫微流月（农历边界）**：
- 使用 `lunar-javascript` 库获取农历日期
- 流月边界以农历初一为准
- 闰月处理：归入前一月计算

### 7.3 年份边界处理

- 干支年以立春为界，非公历1月1日
- 丑月（小寒~立春）跨越公历年份，但属于同一干支年
- 列表输出时明确标注此特殊情况

### 7.4 年龄计算

- 大运/大限使用虚岁（出生即1岁，过年+1）
- 公历年范围作为参考显示
- 明确标注"虚岁"字样

## 8. 待确认事项

1. **四化显示**：流年/流月/流日列表中是否需要显示对应的四化？
   - 当前设计：大限列表不显示四化，流年列表可根据需求添加

2. **分页**：流日列表可能较长（约30天），是否需要分页？
   - 当前设计：不分页，一次返回完整月份

3. **时辰列表**：是否需要支持流时查询？
   - 当前设计：暂不支持，可后续扩展

## 9. 版本历史

| 版本 | 日期 | 变更说明 |
|-----|------|---------|
| 1.0.0 | 2024-12-16 | 初始版本 |
| 1.1.0 | 2025-12-16 | **重要修正**：紫微流月使用农历月（非干支月），更新第2、5.3、5.4、6.2、7.2节 |
